{"ast":null,"code":"\"use strict\";\n\nvar __importDefault = this && this.__importDefault || function (mod) {\n  return mod && mod.__esModule ? mod : {\n    \"default\": mod\n  };\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nconst encoding_1 = require(\"@iov/encoding\");\n\nconst bn_js_1 = __importDefault(require(\"bn.js\"));\n\nconst elliptic_1 = __importDefault(require(\"elliptic\"));\n\nconst hmac_1 = require(\"./hmac\");\n\nconst sha_1 = require(\"./sha\");\n/**\n * Raw values must match the curve string in SLIP-0010 master key generation\n *\n * @see https://github.com/satoshilabs/slips/blob/master/slip-0010.md#master-key-generation\n */\n\n\nvar Slip10Curve;\n\n(function (Slip10Curve) {\n  Slip10Curve[\"Secp256k1\"] = \"Bitcoin seed\";\n  Slip10Curve[\"Ed25519\"] = \"ed25519 seed\";\n})(Slip10Curve = exports.Slip10Curve || (exports.Slip10Curve = {}));\n/**\n * Reverse mapping of Slip10Curve\n */\n\n\nfunction slip10CurveFromString(curveString) {\n  switch (curveString) {\n    case Slip10Curve.Ed25519:\n      return Slip10Curve.Ed25519;\n\n    case Slip10Curve.Secp256k1:\n      return Slip10Curve.Secp256k1;\n\n    default:\n      throw new Error(`Unknown curve string: '${curveString}'`);\n  }\n}\n\nexports.slip10CurveFromString = slip10CurveFromString;\n\nclass Slip10RawIndex extends encoding_1.Uint32 {\n  static hardened(hardenedIndex) {\n    return new Slip10RawIndex(hardenedIndex + 2 ** 31);\n  }\n\n  static normal(normalIndex) {\n    return new Slip10RawIndex(normalIndex);\n  }\n\n  isHardened() {\n    return this.data >= 2 ** 31;\n  }\n\n}\n\nexports.Slip10RawIndex = Slip10RawIndex;\nconst secp256k1 = new elliptic_1.default.ec(\"secp256k1\"); // Universal private key derivation accoring to\n// https://github.com/satoshilabs/slips/blob/master/slip-0010.md\n\nclass Slip10 {\n  static derivePath(curve, seed, path) {\n    let result = this.master(curve, seed);\n\n    for (const rawIndex of path) {\n      result = this.child(curve, result.privkey, result.chainCode, rawIndex);\n    }\n\n    return result;\n  }\n\n  static master(curve, seed) {\n    const i = new hmac_1.Hmac(sha_1.Sha512, encoding_1.Encoding.toAscii(curve)).update(seed).digest();\n    const il = i.slice(0, 32);\n    const ir = i.slice(32, 64);\n\n    if (curve !== Slip10Curve.Ed25519 && (this.isZero(il) || this.isGteN(curve, il))) {\n      return this.master(curve, i);\n    }\n\n    return {\n      chainCode: ir,\n      privkey: il\n    };\n  }\n\n  static child(curve, parentPrivkey, parentChainCode, rawIndex) {\n    let i;\n\n    if (rawIndex.isHardened()) {\n      const payload = new Uint8Array([0x00, ...parentPrivkey, ...rawIndex.toBytesBigEndian()]);\n      i = new hmac_1.Hmac(sha_1.Sha512, parentChainCode).update(payload).digest();\n    } else {\n      if (curve === Slip10Curve.Ed25519) {\n        throw new Error(\"Normal keys are not allowed with ed25519\");\n      } else {\n        // Step 1 of https://github.com/satoshilabs/slips/blob/master/slip-0010.md#private-parent-key--private-child-key\n        // Calculate I = HMAC-SHA512(Key = c_par, Data = ser_P(point(k_par)) || ser_32(i)).\n        // where the functions point() and ser_p() are defined in BIP-0032\n        const data = new Uint8Array([...Slip10.serializedPoint(curve, new bn_js_1.default(parentPrivkey)), ...rawIndex.toBytesBigEndian()]);\n        i = new hmac_1.Hmac(sha_1.Sha512, parentChainCode).update(data).digest();\n      }\n    }\n\n    return this.childImpl(curve, parentPrivkey, parentChainCode, rawIndex, i);\n  }\n  /**\n   * Implementation of ser_P(point(k_par)) from BIP-0032\n   *\n   * @see https://github.com/bitcoin/bips/blob/master/bip-0032.mediawiki\n   */\n\n\n  static serializedPoint(curve, p) {\n    switch (curve) {\n      case Slip10Curve.Secp256k1:\n        return encoding_1.Encoding.fromHex(secp256k1.g.mul(p).encodeCompressed(\"hex\"));\n\n      default:\n        throw new Error(\"curve not supported\");\n    }\n  }\n\n  static childImpl(curve, parentPrivkey, parentChainCode, rawIndex, i) {\n    // step 2 (of the Private parent key → private child key algorithm)\n    const il = i.slice(0, 32);\n    const ir = i.slice(32, 64); // step 3\n\n    const returnChainCode = ir; // step 4\n\n    if (curve === Slip10Curve.Ed25519) {\n      return {\n        chainCode: returnChainCode,\n        privkey: il\n      };\n    } // step 5\n\n\n    const n = this.n(curve);\n    const returnChildKeyAsNumber = new bn_js_1.default(il).add(new bn_js_1.default(parentPrivkey)).mod(n);\n    const returnChildKey = Uint8Array.from(returnChildKeyAsNumber.toArray(\"be\", 32)); // step 6\n\n    if (this.isGteN(curve, il) || this.isZero(returnChildKey)) {\n      const newI = new hmac_1.Hmac(sha_1.Sha512, parentChainCode).update(new Uint8Array([0x01, ...ir, ...rawIndex.toBytesBigEndian()])).digest();\n      return this.childImpl(curve, parentPrivkey, parentChainCode, rawIndex, newI);\n    } // step 7\n\n\n    return {\n      chainCode: returnChainCode,\n      privkey: returnChildKey\n    };\n  }\n\n  static isZero(privkey) {\n    return privkey.every(byte => byte === 0);\n  }\n\n  static isGteN(curve, privkey) {\n    const keyAsNumber = new bn_js_1.default(privkey);\n    return keyAsNumber.gte(this.n(curve));\n  }\n\n  static n(curve) {\n    switch (curve) {\n      case Slip10Curve.Secp256k1:\n        return new bn_js_1.default(\"FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEBAAEDCE6AF48A03BBFD25E8CD0364141\", 16);\n\n      default:\n        throw new Error(\"curve not supported\");\n    }\n  }\n\n}\n\nexports.Slip10 = Slip10;","map":{"version":3,"sources":["../src/slip10.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["\"use strict\";\nvar __importDefault = (this && this.__importDefault) || function (mod) {\n    return (mod && mod.__esModule) ? mod : { \"default\": mod };\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nconst encoding_1 = require(\"@iov/encoding\");\nconst bn_js_1 = __importDefault(require(\"bn.js\"));\nconst elliptic_1 = __importDefault(require(\"elliptic\"));\nconst hmac_1 = require(\"./hmac\");\nconst sha_1 = require(\"./sha\");\n/**\n * Raw values must match the curve string in SLIP-0010 master key generation\n *\n * @see https://github.com/satoshilabs/slips/blob/master/slip-0010.md#master-key-generation\n */\nvar Slip10Curve;\n(function (Slip10Curve) {\n    Slip10Curve[\"Secp256k1\"] = \"Bitcoin seed\";\n    Slip10Curve[\"Ed25519\"] = \"ed25519 seed\";\n})(Slip10Curve = exports.Slip10Curve || (exports.Slip10Curve = {}));\n/**\n * Reverse mapping of Slip10Curve\n */\nfunction slip10CurveFromString(curveString) {\n    switch (curveString) {\n        case Slip10Curve.Ed25519:\n            return Slip10Curve.Ed25519;\n        case Slip10Curve.Secp256k1:\n            return Slip10Curve.Secp256k1;\n        default:\n            throw new Error(`Unknown curve string: '${curveString}'`);\n    }\n}\nexports.slip10CurveFromString = slip10CurveFromString;\nclass Slip10RawIndex extends encoding_1.Uint32 {\n    static hardened(hardenedIndex) {\n        return new Slip10RawIndex(hardenedIndex + 2 ** 31);\n    }\n    static normal(normalIndex) {\n        return new Slip10RawIndex(normalIndex);\n    }\n    isHardened() {\n        return this.data >= 2 ** 31;\n    }\n}\nexports.Slip10RawIndex = Slip10RawIndex;\nconst secp256k1 = new elliptic_1.default.ec(\"secp256k1\");\n// Universal private key derivation accoring to\n// https://github.com/satoshilabs/slips/blob/master/slip-0010.md\nclass Slip10 {\n    static derivePath(curve, seed, path) {\n        let result = this.master(curve, seed);\n        for (const rawIndex of path) {\n            result = this.child(curve, result.privkey, result.chainCode, rawIndex);\n        }\n        return result;\n    }\n    static master(curve, seed) {\n        const i = new hmac_1.Hmac(sha_1.Sha512, encoding_1.Encoding.toAscii(curve)).update(seed).digest();\n        const il = i.slice(0, 32);\n        const ir = i.slice(32, 64);\n        if (curve !== Slip10Curve.Ed25519 && (this.isZero(il) || this.isGteN(curve, il))) {\n            return this.master(curve, i);\n        }\n        return {\n            chainCode: ir,\n            privkey: il,\n        };\n    }\n    static child(curve, parentPrivkey, parentChainCode, rawIndex) {\n        let i;\n        if (rawIndex.isHardened()) {\n            const payload = new Uint8Array([0x00, ...parentPrivkey, ...rawIndex.toBytesBigEndian()]);\n            i = new hmac_1.Hmac(sha_1.Sha512, parentChainCode).update(payload).digest();\n        }\n        else {\n            if (curve === Slip10Curve.Ed25519) {\n                throw new Error(\"Normal keys are not allowed with ed25519\");\n            }\n            else {\n                // Step 1 of https://github.com/satoshilabs/slips/blob/master/slip-0010.md#private-parent-key--private-child-key\n                // Calculate I = HMAC-SHA512(Key = c_par, Data = ser_P(point(k_par)) || ser_32(i)).\n                // where the functions point() and ser_p() are defined in BIP-0032\n                const data = new Uint8Array([\n                    ...Slip10.serializedPoint(curve, new bn_js_1.default(parentPrivkey)),\n                    ...rawIndex.toBytesBigEndian(),\n                ]);\n                i = new hmac_1.Hmac(sha_1.Sha512, parentChainCode).update(data).digest();\n            }\n        }\n        return this.childImpl(curve, parentPrivkey, parentChainCode, rawIndex, i);\n    }\n    /**\n     * Implementation of ser_P(point(k_par)) from BIP-0032\n     *\n     * @see https://github.com/bitcoin/bips/blob/master/bip-0032.mediawiki\n     */\n    static serializedPoint(curve, p) {\n        switch (curve) {\n            case Slip10Curve.Secp256k1:\n                return encoding_1.Encoding.fromHex(secp256k1.g.mul(p).encodeCompressed(\"hex\"));\n            default:\n                throw new Error(\"curve not supported\");\n        }\n    }\n    static childImpl(curve, parentPrivkey, parentChainCode, rawIndex, i) {\n        // step 2 (of the Private parent key → private child key algorithm)\n        const il = i.slice(0, 32);\n        const ir = i.slice(32, 64);\n        // step 3\n        const returnChainCode = ir;\n        // step 4\n        if (curve === Slip10Curve.Ed25519) {\n            return {\n                chainCode: returnChainCode,\n                privkey: il,\n            };\n        }\n        // step 5\n        const n = this.n(curve);\n        const returnChildKeyAsNumber = new bn_js_1.default(il).add(new bn_js_1.default(parentPrivkey)).mod(n);\n        const returnChildKey = Uint8Array.from(returnChildKeyAsNumber.toArray(\"be\", 32));\n        // step 6\n        if (this.isGteN(curve, il) || this.isZero(returnChildKey)) {\n            const newI = new hmac_1.Hmac(sha_1.Sha512, parentChainCode)\n                .update(new Uint8Array([0x01, ...ir, ...rawIndex.toBytesBigEndian()]))\n                .digest();\n            return this.childImpl(curve, parentPrivkey, parentChainCode, rawIndex, newI);\n        }\n        // step 7\n        return {\n            chainCode: returnChainCode,\n            privkey: returnChildKey,\n        };\n    }\n    static isZero(privkey) {\n        return privkey.every(byte => byte === 0);\n    }\n    static isGteN(curve, privkey) {\n        const keyAsNumber = new bn_js_1.default(privkey);\n        return keyAsNumber.gte(this.n(curve));\n    }\n    static n(curve) {\n        switch (curve) {\n            case Slip10Curve.Secp256k1:\n                return new bn_js_1.default(\"FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEBAAEDCE6AF48A03BBFD25E8CD0364141\", 16);\n            default:\n                throw new Error(\"curve not supported\");\n        }\n    }\n}\nexports.Slip10 = Slip10;\n//# sourceMappingURL=slip10.js.map"]},"metadata":{},"sourceType":"script"}